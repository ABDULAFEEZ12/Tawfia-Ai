<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher - Live Classroom</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #4CAF50; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .room-info { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .video-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .video-box { flex: 1; background: black; border-radius: 10px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-start { background: #4CAF50; color: white; }
        .btn-stop { background: #f44336; color: white; }
        .btn-copy { background: #2196F3; color: white; }
        .students-list { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .student-item { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüè´ Teacher Dashboard</h1>
            <p id="roomStatus">Setting up room...</p>
        </div>
        
        <div class="room-info">
            <h3>üì§ Share with Students</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="roomLink" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button onclick="copyRoomLink()" class="btn-copy">üìã Copy Link</button>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="startBroadcast()" class="btn-start" id="startBtn">‚ñ∂Ô∏è Start Broadcasting</button>
            <button onclick="stopBroadcast()" class="btn-stop" id="stopBtn" disabled>‚èπÔ∏è Stop Broadcasting</button>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <video id="localVideo" autoplay muted playsinline></video>
                <div style="position: absolute; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;">You (Teacher)</div>
            </div>
        </div>
        
        <div class="students-list">
            <h3>üë• Connected Students (<span id="studentCount">0</span>)</h3>
            <div id="studentsContainer" style="margin-top: 10px;">
                <p style="color: #666; text-align: center; padding: 20px;">Waiting for students to join...</p>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const roomId = "{{ room_id }}";
        const socket = io();
        let localStream = null;
        let peerConnections = {}; // Map of student_sid -> RTCPeerConnection
        
        // ============================================
        // ROOM MANAGEMENT
        // ============================================
        function updateRoomLink() {
            const baseUrl = window.location.origin;
            const studentUrl = `${baseUrl}/student/${roomId}`;
            document.getElementById('roomLink').value = studentUrl;
            document.getElementById('roomStatus').textContent = `Room: ${roomId}`;
        }
        
        function copyRoomLink() {
            const link = document.getElementById('roomLink');
            link.select();
            link.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(link.value);
            alert('Link copied to clipboard!');
        }
        
        // ============================================
        // WEBCAM SETUP
        // ============================================
        async function setupWebcam() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });
                
                const video = document.getElementById('localVideo');
                video.srcObject = localStream;
                
                document.getElementById('startBtn').disabled = false;
                console.log('‚úÖ Webcam ready');
            } catch (error) {
                console.error('‚ùå Webcam error:', error);
                alert('Camera/microphone access required!');
            }
        }
        
        // ============================================
        // WEBRTC (SIMPLE - TEACHER CREATES OFFERS)
        // ============================================
        async function createPeerConnection(studentSid) {
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            // Add local tracks
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
            
            // ICE candidate handling
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('rtc-ice-candidate', {
                        room: roomId,
                        candidate: event.candidate,
                        target_sid: studentSid
                    });
                }
            };
            
            // Create and send offer
            const offer = await pc.createOffer({
                offerToReceiveAudio: false,
                offerToReceiveVideo: false
            });
            
            await pc.setLocalDescription(offer);
            
            socket.emit('rtc-offer', {
                room: roomId,
                offer: offer,
                target_sid: studentSid
            });
            
            return pc;
        }
        
        // ============================================
        // SOCKET.IO HANDLERS
        // ============================================
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
            socket.emit('join-room', {
                room: roomId,
                role: 'teacher',
                user_id: `teacher_${Date.now()}`,
                username: 'Teacher'
            });
            
            updateRoomLink();
            setupWebcam();
        });
        
        socket.on('room-joined', (data) => {
            console.log('‚úÖ Joined room as teacher');
            showNotification('Room created successfully!');
        });
        
        socket.on('student-joined', async (data) => {
            const { sid, username, user_id } = data;
            console.log(`üéì Student joined: ${username}`);
            
            // Add to UI
            addStudentToList(sid, username);
            
            // Create WebRTC connection with this student
            if (localStream) {
                const pc = await createPeerConnection(sid);
                peerConnections[sid] = pc;
                showNotification(`${username} joined the class`);
            }
        });
        
        socket.on('student-left', (data) => {
            const { sid } = data;
            console.log(`üéì Student left: ${sid}`);
            
            // Remove from UI
            removeStudentFromList(sid);
            
            // Close WebRTC connection
            if (peerConnections[sid]) {
                peerConnections[sid].close();
                delete peerConnections[sid];
            }
        });
        
        socket.on('rtc-answer', (data) => {
            const { answer, sid } = data;
            const pc = peerConnections[sid];
            if (pc) {
                pc.setRemoteDescription(new RTCSessionDescription(answer));
                console.log(`‚úÖ WebRTC connected with student ${sid}`);
            }
        });
        
        socket.on('rtc-ice-candidate', (data) => {
            const { candidate, sid } = data;
            const pc = peerConnections[sid];
            if (pc && candidate) {
                pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });
        
        socket.on('error', (data) => {
            console.error('‚ùå Server error:', data);
            showNotification(data.message || 'Error');
        });
        
        // ============================================
        // UI FUNCTIONS
        // ============================================
        function addStudentToList(sid, username) {
            const container = document.getElementById('studentsContainer');
            const existing = document.getElementById(`student-${sid}`);
            
            if (!existing) {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.id = `student-${sid}`;
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${username}</strong>
                            <div style="font-size: 0.8em; color: #666;">${sid.substring(0, 8)}...</div>
                        </div>
                        <span style="color: #4CAF50;">‚óè Connected</span>
                    </div>
                `;
                container.appendChild(div);
                
                // Remove waiting message if present
                const waitingMsg = container.querySelector('p');
                if (waitingMsg && waitingMsg.textContent.includes('Waiting')) {
                    container.removeChild(waitingMsg);
                }
                
                updateStudentCount();
            }
        }
        
        function removeStudentFromList(sid) {
            const element = document.getElementById(`student-${sid}`);
            if (element) {
                element.remove();
                updateStudentCount();
            }
        }
        
        function updateStudentCount() {
            const count = document.querySelectorAll('.student-item').length;
            document.getElementById('studentCount').textContent = count;
            
            const container = document.getElementById('studentsContainer');
            if (count === 0 && !container.querySelector('p')) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Waiting for students to join...</p>';
            }
        }
        
        function showNotification(message) {
            // Simple notification
            alert(message);
        }
        
        function startBroadcast() {
            socket.emit('start-broadcast', { room: roomId });
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            showNotification('Broadcasting started!');
        }
        
        function stopBroadcast() {
            socket.emit('stop-broadcast', { room: roomId });
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            showNotification('Broadcasting stopped');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateRoomLink();
        });
    </script>
</body>
</html>
