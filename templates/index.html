<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tawfiq AI - Smart Islamic Companion</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- External CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<!-- Updated and Enhanced CSS for Mobile & Aesthetics -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f4;
  color: #333;
  line-height: 1.6;
  scroll-behavior: smooth;
  overflow-x: hidden;
}

/* Header styles */
h1, h3 {
  text-align: center;
  margin: 20px 10px;
  font-weight: 600;
}
header h1 {
  font-size: 1.8em;
  color: #222;
}
header h3 {
  font-size: 1.2em;
  color: #555;
}

/* Menu toggle button style */
#menu-toggle {
  font-size: 28px;
  cursor: pointer;
  position: fixed;
  top: 20px;
  left: 15px;
  z-index: 1001;
  background: #fff;
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}
#menu-toggle:hover {
  background: #eee;
  transform: scale(1.05);
}

/* Sidebar menu styles */
#side-menu {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  height: 100%;
  background-color: #121212;
  color: #fff;
  padding-top: 70px;
  transition: all 0.3s ease;
  z-index: 1000;
  overflow-y: auto;
  border-top-right-radius: 12px;
  border-bottom-right-radius: 12px;
}
#side-menu.hidden {
  left: -280px;
}
#side-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
#side-menu li {
  padding: 16px 20px;
  border-bottom: 1px solid #333;
  cursor: pointer;
  font-size: 1em;
  transition: background 0.2s, transform 0.1s;
}
#side-menu li:hover {
  background-color: #333;
  transform: translateX(2px);
}
#side-menu a {
  color: inherit;
  text-decoration: none;
  display: block;
}

/* Tabs styles */
.tabs {
  margin-top: 100px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 12px;
}
.tab {
  padding: 10px 20px;
  border-radius: 25px;
  background-color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
  transition: background 0.3s, transform 0.2s;
}
.tab.active, .tab:hover {
  background-color: #ddd;
  transform: scale(1.02);
}

/* Sections styling */
.section {
  display: none;
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
  background-color: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-top: 20px;
  width: 100%;
}
.section.active {
  display: block;
}

/* Input styles */
input[type="text"], select {
  width: 100%;
  padding: 12px 15px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1em;
  font-family: 'Poppins', sans-serif;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  transition: border-color 0.2s;
}
input[type="text"]:focus, select:focus {
  border-color: #007bff;
  outline: none;
}

/* Buttons styling */
button {
  margin-top: 12px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background-color: #007bff;
  color: #fff;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background 0.3s, transform 0.2s;
}
button:hover {
  background-color: #0056b3;
  transform: scale(1.02);
}

/* Messages styles */
.messages {
  margin-top: 20px;
  background-color: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  max-height: 300px;
  overflow-y: auto;
  font-family: 'Poppins', sans-serif;
  display: flex;
  flex-direction: column;
}

/* User message - right aligned, green bubble */
.user-message {
  align-self: flex-end;
  background-color: #dcf8c6; /* WhatsApp greenish */
  color: #222;
  padding: 10px 14px;
  border-radius: 20px;
  margin-bottom: 10px;
  max-width: 75%;
  word-wrap: break-word;
  font-weight: 600;
  font-family: 'Poppins', sans-serif;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Tawfiq AI message - left aligned, white/blue bubble */
.ai-message {
  align-self: flex-start;
  background-color: #f1f0f0; /* Light gray/white */
  color: #222;
  padding: 10px 14px;
  border-radius: 20px;
  margin-bottom: 10px;
  max-width: 75%;
  word-wrap: break-word;
  font-family: 'Poppins', sans-serif;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.ai-message.blue {
  background-color: #e0f7fa; /* Light blue */
}

/* Loading indicator style */
.loading-indicator {
  font-style: italic;
  color: #555;
}

/* Scrollbar styles for WebKit browsers */
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,0.2);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0,0,0,0.4);
}

/* Firefox scrollbar */
body {
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.2) transparent;
}

/* Responsive font sizes and layout adjustments for small screens */
@media(max-width: 600px) {
  body {
    font-size: 0.95em;
  }
  header h1 {
    font-size: 1.4em;
  }
  header h3 {
    font-size: 1em;
  }
  #menu-toggle {
    font-size: 24px;
    padding: 6px 10px;
  }
  .tab {
    padding: 8px 16px;
    font-size: 0.95em;
  }
  button {
    padding: 10px 16px;
    font-size: 0.95em;
  }
}
</style>
</head>
<body class="light-mode">

<!-- MENU TOGGLE BUTTON -->
<div id="menu-toggle" onclick="toggleMenu()">‚ò∞</div>

<!-- SIDEBAR MENU -->
<div id="side-menu" class="hidden">
  <ul>
    <li><a href="/profile">üë§ Profile</a></li>
    <li><a href="/prayer-times">üïå Prayer Times</a></li>
    <li><a href="/daily-dua">üïå Daily Dua</a></li>
    <li><a href="/reminder">üìÖ Daily Reminder</a></li>
    <li><a href="/motivation">‚ú® Islamic Motivation</a></li>
    <li><a href="/settings">‚öôÔ∏è Settings</a></li>
    <li><a href="/privacy">üîí Privacy & Policy</a></li>
    <li><a href="/about">‚ÑπÔ∏è About Tawfiq AI</a></li>
    <li><a href="/feedback">üì¢ Feedback / Report</a></li>
  </ul>
</div>

<!-- Toggle Mode Button -->
<button class="toggle-btn" onclick="toggleMode()">Toggle Mode</button>

<!-- Main Header -->
<header>
<h1>üåô Tawfiq AI - Smart Islamic Companion üåô</h1>
<h3>‚ú® Ask me anything about Islam ‚ú®</h3>
</header>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('aiSection', event)">ü§ñ AI</div>
  <div class="tab" onclick="switchTab('quranSection', event)">üìñ Quran</div>
  <div class="tab" onclick="switchTab('hadithSection', event)">üìú Hadith</div>
</div>

<!-- AI Section -->
<div class="section active" id="aiSection">
  <div class="messages" id="messages"></div>
  <input type="text" id="userInput" placeholder="Ask a question about Islam..." />
  <button id="askButton" onclick="sendQuestion()">Ask</button>
</div>

<!-- Quran Section -->
<div class="section" id="quranSection">
  <input type="text" id="quranInput" placeholder="Enter Surah name or keyword..."/>
  <select id="surahList">
    <option value="">-- Or Select Surah --</option>
  </select>
  <button id="quranSearchButton" onclick="searchQuran()">Search Surah</button>
  <div class="results" id="quranResult"></div>
</div>

<!-- Hadith Section -->
<div class="section" id="hadithSection">
  <input type="text" id="hadithInput" placeholder="Enter Hadith keyword or number..."/>
  <select id="hadithDropdown">
    <option value="">-- Or Select Hadith Topic --</option>
  </select>
  <button id="hadithSearchButton" onclick="searchHadith()">Search Hadith</button>
  <div class="results" id="hadithResult"></div>
</div>

<!-- Dua Section (Main) -->
<div class="section" id="duaSection">
  <h3>Today's Dua</h3>
  <div id="duaText">Loading Dua...</div>
  <!-- The prominent Daily Dua box -->
  <div id="dailyDuaSection">
    <h2>üïå Daily Dua üìø</h2>
    <div id="dailyDuaContent" style="font-size: 1.2em; padding: 10px; text-align: center;">Loading the Dua of the Day...</div>
  </div>
</div>

<!-- Motivation Section -->
<div class="section" id="motivationSection">
  <h3>Daily Motivation</h3>
  <div id="motivationText">Loading Motivation...</div>
</div>

<!-- Prayer Times Section -->
<div class="section" id="prayerTimes" style="display:none;">
  <h3>üïå Prayer Times</h3>
  <div id="prayerTimesContent" style="padding: 10px;">
    <p>Loading prayer times...</p>
  </div>
</div>

<!-- Daily Dua Menu Section (for menu navigation) -->
<div class="section" id="dailyDuaMenu" style="display:none;">
  <h3>üïå Daily Dua üìø</h3>
  <div id="dailyDuaContentMenu" style="font-size: 1.2em; padding: 10px; text-align: center;">Loading the Dua of the Day...</div>
</div>

<script>
  // Initialize chat history
  let chatHistory = [];

  // Function to switch between main sections
  function switchTab(sectionId, event) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    event.target.classList.add('active');
  }

  // Function to toggle light/dark mode
  function toggleMode() {
    document.body.classList.toggle('light-mode');
    document.body.classList.toggle('dark-mode');
    const toggleBtn = document.querySelector('.toggle-btn');
    if (document.body.classList.contains('dark-mode')) {
      toggleBtn.textContent = 'Toggle Light Mode';
    } else {
      toggleBtn.textContent = 'Toggle Dark Mode';
    }
  }

  // Function for navigation (not used if full page links are used)
  function goTo(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    const section = document.getElementById(sectionId);
    if(section) {
      section.style.display='block';
      if(sectionId==='prayerTimes') {
        loadPrayerTimes();
      }
    }
  }

  // Function to toggle menu visibility
  function toggleMenu() {
    document.getElementById('side-menu').classList.toggle('hidden');
  }

  // Load Daily Dua into main section and menu on page load
  function loadDailyDua() {
    fetch('data/daily_duas.json')
      .then(res => res.json())
      .then(data => {
        const dua = data.dua || "No Dua available.";
        document.getElementById('dailyDuaContent').innerHTML = `<p>"${dua}"</p>`;
        document.getElementById('dailyDuaContentMenu').innerHTML = `<p>"${dua}"</p>`;
      })
      .catch(error => {
        document.getElementById('dailyDuaContent').innerHTML = '<p>Unable to load Dua for today.</p>';
        document.getElementById('dailyDuaContentMenu').innerHTML = '<p>Unable to load Dua for today.</p>';
        console.error('Error loading daily_duas.json:', error);
      });
  }

  // Load prayer times
  function loadPrayerTimes() {
    fetch('/get-prayer-times')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('prayerTimesContent');
        if (data && data.prayer_times) {
          container.innerHTML = '';
          for (const [name, time] of Object.entries(data.prayer_times)) {
            const p = document.createElement('p');
            p.innerHTML = `<strong>${name}:</strong> ${time}`;
            container.appendChild(p);
          }
        } else {
          container.innerHTML = '<p>Prayer times data unavailable.</p>';
        }
      })
      .catch(error => {
        console.error('Error fetching prayer times:', error);
        document.getElementById('prayerTimesContent').innerHTML = '<p>Error loading prayer times.</p>';
      });
  }

  // Load Surah list
  function loadSurahList() {
    fetch('/get-surah-list')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('surahList');
        select.innerHTML = '<option value="">-- Or Select Surah --</option>';
        if (data && data.surahs && Array.isArray(data.surahs)) {
          data.surahs.forEach(surah => {
            const option = document.createElement('option');
            option.value = surah;
            option.textContent = surah;
            select.appendChild(option);
          });
        } else {
          loadHardcodedSurahList();
        }
      })
      .catch(error => {
        console.error('Error loading Surah list:', error);
        loadHardcodedSurahList();
      });
  }

  function loadHardcodedSurahList() {
    const surahs = [
      "Al-Fatihah", "Al-Baqarah", "Aali Imran", "An-Nisa", "Al-Maidah", "Al-Anam", "Al-Araf",
      "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Rad", "Ibrahim", "Al-Hijr",
      "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya", "Al-Hajj", "Al-Muminun",
      "An-Nur", "Al-Furqan", "Ash-Shuara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
      "Luqman", "As-Sajda", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad",
      "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiya",
      "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur",
      "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'a", "Al-Hadid", "Al-Mujadila", "Al-Hashr",
      "Al-Mumtahanah", "As-Saff", "Al-Jumu'a", "Al-Munafiqun", "At-Taghabun", "At-Talaq",
      "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn",
      "Al-Muzzammil", "Al-Muddathir", "Al-Qiyama", "Al-Insan", "Al-Mursalat", "An-Naba",
      "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq",
      "Al-Buruj", "At-Tariq", "Al-Ala", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams",
      "Al-Lail", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyina",
      "Az-Zalzalah", "Al-Adiyat", "Al-Qari'a", "At-Takathur", "Al-Asr", "Al-Humazah",
      "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad",
      "Al-Ikhlas", "Al-Falaq", "An-Nas"
    ];
    const select = document.getElementById('surahList');
    surahs.forEach(surah => {
      const option = document.createElement('option');
      option.value = surah;
      option.textContent = surah;
      select.appendChild(option);
    });
  }

  // Load Hadith topics
  function loadHadithTopics() {
    const topics = [
      "Hadith on Prayer", "Hadith on Faith", "Hadith on Charity", "Hadith on Patience",
      "Hadith on Gratitude", "Hadith on Kindness", "Hadith on Fasting", "Hadith on Hajj",
      "Hadith on Honesty", "Hadith on Forgiveness", "Hadith on Parents", "Hadith on Children",
      "Hadith on Marriage", "Hadith on Neighbors", "Hadith on Brotherhood", "Hadith on Modesty",
      "Hadith on Repenance", "Hadith on Mercy", "Hadith on Humility", "Hadith on Envy",
      "Hadith on Justice", "Hadith on Knowledge", "Hadith on Dua", "Hadith on Quran",
      "Hadith on Sunnah", "Hadith on Hellfire", "Hadith on Paradise", "Hadith on Backbiting",
      "Hadith on Lying", "Hadith on Trust", "Hadith on Trade", "Hadith on Wealth",
      "Hadith on Poverty", "Hadith on Oppression", "Hadith on Manners", "Hadith on Sincerity",
      "Hadith on Innovation", "Hadith on Angels", "Hadith on Jinn", "Hadith on Death",
      "Hadith on Resurrection", "Hadith on Signs of Day of Judgment", "Hadith on Health",
      "Hadith on Cleanliness", "Hadith on Generosity", "Hadith on Bribery", "Hadith on Gossip",
      "Hadith on Leadership", "Hadith on Love", "Hadith on Peace", "Hadith on Prayer at Night",
      "Hadith on Ablution", "Hadith on Sadaqah", "Hadith on Zakat", "Hadith on Seeking Knowledge",
      "Hadith on Good Deeds", "Hadith on Evil Deeds", "Hadith on Hypocrisy", "Hadith on Arrogance",
      "Hadith on Tawheed", "Hadith on Shirk", "Hadith on Respecting Elders", "Hadith on Youth",
      "Hadith on Orphans", "Hadith on Widows", "Hadith on Modesty in Dressing",
      "Hadith on Halal and Haram", "Hadith on Gossip", "Hadith on Anger", "Hadith on Smiling",
      "Hadith on Good Speech", "Hadith on Contentment", "Hadith on Worldly Life",
      "Hadith on Akhirah", "Hadith on Thankfulness", "Hadith on Seeking Forgiveness",
      "Hadith on Trials", "Hadith on Signs of Hypocrites", "Hadith on Visiting Graves",
      "Hadith on Trust in Allah", "Hadith on Destiny", "Hadith on Martyrdom", "Hadith on Courage",
      "Hadith on Sin", "Hadith on Purification", "Hadith on Eid", "Hadith on Sacrifice",
      "Hadith on Brotherhood in Islam", "Hadith on Leadership in Islam", "Hadith on Reciting Quran",
      "Hadith on Betrayal", "Hadith on Contentment", "Hadith on Piety", "Hadith on Remembrance of Allah",
      "Hadith on Friday Prayer", "Hadith on Allah‚Äôs Mercy", "Hadith on Night of Qadr",
      "Hadith on Family Ties"
    ];
    const dropdown = document.getElementById('hadithDropdown');
    topics.forEach(topic => {
      const option = document.createElement('option');
      option.value = topic;
      option.textContent = topic;
      dropdown.appendChild(option);
    });
  }

  // Load Daily Dua into main and menu sections on page load
  function loadDailyDua() {
    fetch('data/daily_duas.json')
      .then(res => res.json())
      .then(data => {
        const dua = data.dua || "No Dua available.";
        document.getElementById('dailyDuaContent').innerHTML = `<p>"${dua}"</p>`;
        document.getElementById('dailyDuaContentMenu').innerHTML = `<p>"${dua}"</p>`;
      })
      .catch(error => {
        document.getElementById('dailyDuaContent').innerHTML = '<p>Unable to load Dua for today.</p>';
        document.getElementById('dailyDuaContentMenu').innerHTML = '<p>Unable to load Dua for today.</p>';
        console.error('Error loading daily_duas.json:', error);
      });
  }

  // Initialize on DOM load
  document.addEventListener("DOMContentLoaded", () => {
    loadDailyDua();
    loadHadithTopics();
    loadSurahList();
  });

  // Function to handle navigation
  function goTo(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    const section = document.getElementById(sectionId);
    if(section) {
      section.style.display='block';
      if(sectionId==='prayerTimes') {
        loadPrayerTimes();
      }
    }
  }

  // Toggle menu
  function toggleMenu() {
    document.getElementById('side-menu').classList.toggle('hidden');
  }

  // Toggle Mode
  function toggleMode() {
    document.body.classList.toggle('light-mode');
    document.body.classList.toggle('dark-mode');
    const toggleBtn = document.querySelector('.toggle-btn');
    if (document.body.classList.contains('dark-mode')) {
      toggleBtn.textContent = 'Toggle Light Mode';
    } else {
      toggleBtn.textContent = 'Toggle Dark Mode';
    }
  }

  // Send question to AI with streaming (Word-by-Word)
async function sendQuestion() {
  const inputEl = document.getElementById("userInput");
  const question = inputEl.value.trim();
  if (!question) return;

  const messagesDiv = document.getElementById("messages");
  
  // User message bubble
  const userMsg = document.createElement("div");
  userMsg.className = "user-message";
  userMsg.textContent = "You: " + question;
  messagesDiv.appendChild(userMsg);
  inputEl.value = "";
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  chatHistory.push({ role: "user", content: question });

  // AI message bubble (start empty, will fill with stream)
  const aiMsg = document.createElement("div");
  aiMsg.className = "ai-message";
  // Add optional blue style
  // aiMsg.classList.add("blue");
  aiMsg.textContent = ""; // start empty
  messagesDiv.appendChild(aiMsg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // Show typing indicator
  showTypingIndicator(true);

  // Prepare stream response
  try {
    const response = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ history: chatHistory, stream: true }) // send stream request
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split("\n").filter(line => line.trim() !== "");

      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const data = line.slice(6).trim();

          if (data === "[DONE]") {
            showTypingIndicator(false);
            return;
          }

          try {
            const json = JSON.parse(data);
            const token = json.choices?.[0]?.delta?.content;

            if (token) {
              fullText += token;
              // Update AI message with live text
              aiMsg.innerHTML = `<div class="ai-message">${fullText}</div>`;
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
          } catch (err) {
            console.error("Error parsing stream:", err);
          }
        }
      }
    }
  } catch (error) {
    console.error('Error:', error);
    showTypingIndicator(false);
    // fallback: append error message
    aiMsg.innerHTML = `<div class="ai-message">Error getting response.</div>`;
  }
}

// Function to show/hide typing indicator
function showTypingIndicator(show) {
  let indicator = document.getElementById('typingIndicator');
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'loading-indicator';
    indicator.innerHTML = 'Tawfiq AI is typing...';
    document.querySelector('.messages').appendChild(indicator);
  }
  indicator.style.display = show ? 'block' : 'none';

  // Optionally, disable/enable ask button during typing
  document.getElementById('askButton').disabled = show;
}

/* You can add CSS for the typing indicator if needed */
</script>
</body>
</html>
