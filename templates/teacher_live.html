
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Live - Room {{ room_id }}</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
        }

        .top-bar {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-info {
            font-weight: 600;
            font-size: 18px;
            color: #1a2980;
        }

        .share-link {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .share-link input {
            padding: 8px 12px;
            width: 320px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-primary {
            background: #1a2980;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 15px;
        }

        .video-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
        }

        .teacher-video-container {
            background: black;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            margin-bottom: 12px;
            position: relative;
        }

        .student-video-container {
            background: black;
            border-radius: 10px;
            overflow: hidden;
            height: 220px;
            border: 3px solid #2ed573;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .students-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            height: fit-content;
        }

        .student-item {
            padding: 10px;
            background: #f4f6ff;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .debug {
            margin-top: 15px;
            background: #f5f7ff;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
<div class="container">

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="room-info">
            Room ID: {{ room_id }}
        </div>

        <div class="share-link">
            <input id="studentLink" readonly>
            <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
        </div>
    </div>

    <div class="main-content">

        <!-- VIDEO AREA -->
        <div class="video-section">

            <!-- TEACHER -->
            <div class="teacher-video-container">
                <video id="teacherVideo" autoplay playsinline muted></video>
                <div class="video-label">Teacher</div>
            </div>

            <!-- STUDENT -->
            <div class="student-video-container">
                <video id="studentVideo" autoplay playsinline></video>
                <div class="video-label" id="studentLabel">Student View</div>
            </div>

            <!-- CONTROLS -->
            <div class="controls">
                <button class="btn btn-primary" id="startBroadcastBtn">
                    <i class="fas fa-play"></i> Start Broadcast
                </button>
                <button class="btn btn-secondary" onclick="toggleVideo()">Camera</button>
                <button class="btn btn-secondary" onclick="toggleAudio()">Mic</button>
                <button class="btn btn-danger" onclick="endSession()">End Session</button>
            </div>

            <div class="debug" id="debugLog"></div>
        </div>

        <!-- STUDENT LIST -->
        <div class="students-section">
            <h3>Students</h3>
            <div id="studentsList"></div>
        </div>

    </div>
</div>

<script>
const roomId = "{{ room_id }}";
const socket = io();

const teacherVideo = document.getElementById("teacherVideo");
const studentVideo = document.getElementById("studentVideo");
const studentLabel = document.getElementById("studentLabel");
const studentsList = document.getElementById("studentsList");
const debugLog = document.getElementById("debugLog");
const startBtn = document.getElementById("startBroadcastBtn");

const studentLinkInput = document.getElementById("studentLink");
studentLinkInput.value = `${window.location.origin}/student_live/${roomId}`;

let localStream;
let students = {};
let peerConnections = {};
let currentStudent = null;

function log(msg) {
    debugLog.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + debugLog.innerHTML;
}

function copyLink() {
    navigator.clipboard.writeText(studentLinkInput.value);
    log("Student link copied");
}

socket.on("connect", () => {
    socket.emit("join-room", {
        room: roomId,
        role: "teacher",
        username: "Teacher"
    });
    log("Connected to server");
});

socket.on("student-joined", data => {
    students[data.sid] = { username: data.username, stream: null };
    renderStudents();
    log(`Student joined: ${data.username}`);
});

socket.on("student-left", data => {
    delete students[data.sid];
    if (currentStudent === data.sid) {
        studentVideo.srcObject = null;
        studentLabel.textContent = "Student View";
        currentStudent = null;
    }
    renderStudents();
    log("Student left");
});

function renderStudents() {
    studentsList.innerHTML = "";
    Object.entries(students).forEach(([sid, s]) => {
        const div = document.createElement("div");
        div.className = "student-item";
        div.textContent = s.username;
        div.onclick = () => {
            if (s.stream) showStudent(sid);
        };
        studentsList.appendChild(div);
    });
}

async function startBroadcast() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    teacherVideo.srcObject = localStream;
    socket.emit("start-broadcast", { room: roomId });
    startBtn.disabled = true;
    log("Broadcast started");
}

function showStudent(sid) {
    studentVideo.srcObject = students[sid].stream;
    studentLabel.textContent = students[sid].username;
    currentStudent = sid;
}

function toggleVideo() {
    if (!localStream) return;
    const track = localStream.getVideoTracks()[0];
    track.enabled = !track.enabled;
}

function toggleAudio() {
    if (!localStream) return;
    const track = localStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
}

function endSession() {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    socket.disconnect();
    window.location.href = "/";
}

startBtn.onclick = startBroadcast;
</script>

</body>
</html>

