<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Live - Room {{ room_id }}</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        /* --- STYLES UNCHANGED --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:Poppins,sans-serif;
            background:linear-gradient(135deg,#1a2980,#26d0ce);
            min-height:100vh;
        }
        /* (CSS unchanged for brevity â€“ UI is untouched) */
    </style>
</head>

<body>
<div class="container">
    <!-- UI UNCHANGED -->
</div>

<script>
/* =========================================================
   ðŸ”’ METERED ICE SERVERS (ONLY PLACE THEY EXIST)
   ========================================================= */
const ICE_SERVERS = [
    { urls: "stun:stun.relay.metered.ca:80" },
    {
        urls: "turn:global.relay.metered.ca:80",
        username: "459b679e028c3f37200569ec",
        credential: "7Y4blbcvHOg1Uhwm"
    },
    {
        urls: "turn:global.relay.metered.ca:80?transport=tcp",
        username: "459b679e028c3f37200569ec",
        credential: "7Y4blbcvHOg1Uhwm"
    },
    {
        urls: "turn:global.relay.metered.ca:443",
        username: "459b679e028c3f37200569ec",
        credential: "7Y4blbcvHOg1Uhwm"
    },
    {
        urls: "turns:global.relay.metered.ca:443?transport=tcp",
        username: "459b679e028c3f37200569ec",
        credential: "7Y4blbcvHOg1Uhwm"
    }
];

/* ========================================================= */

const roomId = "{{ room_id }}";
const socket = io();

let localStream = null;
let peerConnections = {};
let students = {};
let isBroadcasting = false;

/* ---------------- INIT ---------------- */
document.addEventListener("DOMContentLoaded", () => {
    socket.emit("join-room", {
        room: roomId,
        role: "teacher",
        username: "Teacher"
    });
});

/* ---------------- SOCKET EVENTS ---------------- */
socket.on("student-joined", ({ sid, username }) => {
    students[sid] = { username };
    if (isBroadcasting) createPeerConnection(sid);
});

socket.on("student-left", ({ sid }) => {
    if (peerConnections[sid]) {
        peerConnections[sid].close();
        delete peerConnections[sid];
    }
    delete students[sid];
});

socket.on("rtc-answer", ({ answer, from_student }) => {
    const pc = peerConnections[from_student];
    if (pc) pc.setRemoteDescription(new RTCSessionDescription(answer));
});

socket.on("rtc-ice-candidate", ({ candidate, from_sid }) => {
    const pc = peerConnections[from_sid];
    if (pc) pc.addIceCandidate(new RTCIceCandidate(candidate));
});

/* ---------------- BROADCAST ---------------- */
async function startBroadcast() {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById("teacherVideo").srcObject = localStream;

    isBroadcasting = true;
    socket.emit("start-broadcast", { room: roomId });

    Object.keys(students).forEach(createPeerConnection);
}

/* ---------------- PEER CONNECTION ---------------- */
function createPeerConnection(studentSid) {
    if (!localStream) return;

    const pc = new RTCPeerConnection({
        iceServers: ICE_SERVERS,
        iceTransportPolicy: "relay",
        bundlePolicy: "max-bundle",
        rtcpMuxPolicy: "require"
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => {
        if (e.candidate) {
            socket.emit("rtc-ice-candidate", {
                room: roomId,
                target_sid: studentSid,
                candidate: e.candidate
            });
        }
    };

    pc.oniceconnectionstatechange = () => {
        console.log("ICE:", pc.iceConnectionState);
    };

    pc.createOffer()
        .then(o => pc.setLocalDescription(o))
        .then(() => {
            socket.emit("rtc-offer", {
                room: roomId,
                target_sid: studentSid,
                offer: pc.localDescription
            });
        });

    peerConnections[studentSid] = pc;
}
</script>

</body>
</html>
